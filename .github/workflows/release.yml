name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.14t"]
        architecture: [x86-64, aarch64]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - name: build (release)
        uses: PyO3/maturin-action@v1
        with:
          manylinux: auto
          command: build
          args: "--release -o dist -i python${{ matrix.python-version }}"
          target: ${{ matrix.architecture == 'aarch64' && 'aarch64-unknown-linux-gnu' || null }}
      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: "wheels-linux-python-${{ matrix.python-version }}-${{ matrix.architecture }}"
          path: dist

  macos:
    runs-on: macos-14
    strategy:
      matrix:
        python-version: ["3.10", "3.14t"]
        architecture: [x86-64, aarch64]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - name: build (release)
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: "--release -o dist -i python${{ matrix.python-version }}"
          target: ${{ matrix.architecture == 'aarch64' && 'aarch64-apple-darwin' || 'x86_64-apple-darwin' }}
      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: "wheels-macos-python-${{ matrix.python-version }}-${{ matrix.architecture }}"
          path: dist

  windows:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.14t"]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - name: build (release)
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: "--release -o dist -i python${{ matrix.python-version }}"
      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: "wheels-windows-python-${{ matrix.python-version }}"
          path: dist

  sdist:
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"
      - name: build (sdist)
        uses: PyO3/maturin-action@v1
        with:
          manylinux: auto
          command: sdist
          args: "-o dist"
      - name: Upload sdist
        uses: actions/upload-artifact@v6
        with:
          name: sdist
          path: dist

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [linux, macos, windows, sdist]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist
          merge-multiple: true

      - name: List artifacts
        run: ls -la dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: dist/*
